sudo: required

language: go

go:
  - 1.7

services:
  - docker

global:
  - COMMIT=${TRAVIS_COMMIT::8}
  # DOCKER_USER
  - secure: UhNyDZRHLBHr67xZmmkf3kv5dLbN1ikeOoPeBxL3cELQlNTJQGXR2tJydoZPh3j0MtDCgL5yWU8YlTzOzK8YBAlRQEHHHZzxfE/FNGfQn2qoNnesdmOV5IUieH4voLLOGdvDTZZ2jNlVkkz188lGxa64bhc7SFL2YM0idmdzQPst7Newf0Ouu429YUnFwf0yedU7/M9mQnUnrj+5WLx0SNIIkdQ49aPP9ja1uve8vCefzq4poIq1Wk3G1kXgprP3kNnwHToaTL6HpZR4KJpCLIC8fwJNjd+yBipCGT0jHqKhiFiU4GQ0jSvft24ujhZbaJOxKb57XKQWtzEwtj1soQ98ayeC9ECgNoWYgs+xWijHh3h9xWRO0XkDH0qrKYMv0f7RGTIz8HxkFXbkGtDg/Sak2MZ5oY3/FzxPlFTs6OADbz37QOWHtWt5L5RvuIY7D5O8yLPuRW2ybZTKE3Bou0ANWioywy/WL+a+OgTq4a5e+dsZA6XOVDUQaRG/Yl262rSDhZxOoyVFgBOBXEGSMAI01SEExcUXx6zl5owvWV74ntLkspWa179tvxPVTxafgzDkw/lFBBwaZ3bSyPae6vqA+7NI0JHlCADtTMx9AeYriywBA/1Oixu7hHN8Ze0srMEnMn2pJpY8P6kX/vmlYhLNkUCD59vRf/zpDv/49ZQ=
  # DOCKER_PASS
  - secure: PeXPN7OhXBLlnGXcUTph/xq8UGqFz3WTrPEv1CnudCV8gVjppXPbWn76TWnhJ2ztcYRaaFsdBoPfYrkzKj0IkFDtlT4w19stZQSBC3Q+DEABjwbiOGsoPUTESmDELQIi7g7MylBQFlDyT1umEXwfteSzKnx929DACGOmF4S6FMOttkNgqyQm6Pyrj6Dk6bjrrylisGL4H50QCsX2j5gjDgHc2xMYYSXRFolb7lNkJ17HSZ/tD4PGhVLeeRPoCygzx0BbsIpZVyvrZHPQrCo9adfF04kCWvWMtNs01XjduAnMQGEgG7LFbMKHs1lmWB2w5LIdxzqsRv/h5DLmHEIutU5qWOQpXr7pC6V/8axOF+aNbqa365iG+F3i8wvYsMQydEv5tY3DVenoJwI5drXda2Bg9oE1SN22Khr2NOs0Oho1T5tQyvhMfJ50Dr+SY67FUKfYtk+RE/bCqPy3PrG+8wUXDIxP3cPWyIAxFeFAqLsdXEhtqL9WyJmX4ZXzvzr8/XZqfCPpek4ly3eMsrbZ+wW5F1xnYQ3z5todKXfHIj0lXcnNDcD7xzITM1GeAi4BUSNzTnk5erR3KRq+R4LZZ6K2lypKidmaRrLP+Z1PpPKnPJ75nenZD6rozn4owZF9NMooLl3W/diYQRY+XpfswYhE2eILfxUofXsrGsCBniY=

install:
  - make install_ci

before_install:
  - make build_standalone_linux
  - make build_examples_linux
  - export REPO=jaegertracing/all-in-one
#  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
#  - export TAG=`if [ "$BRANCH" == "master" ]; then echo "latest"; else echo $BRANCH; fi`
  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, REPO=$REPO, PR=$PR, BRANCH=$BRANCH, TAG=$TAG"
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - docker build -f cmd/standalone/Dockerfile -t $REPO:$COMMIT .
  - docker tag $REPO:$COMMIT $REPO:$TAG
  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
  - docker push $REPO

script:
  - make test_ci
  - travis_retry goveralls -coverprofile=cover.out -service=travis-ci || true

#after_success:
#  - make build_standalone_linux
#  - make build_examples_linux
#  - export REPO=jaegertracing/all-in-one
#  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
#  - export TAG=`if [ "$BRANCH" == "master" ]; then echo "latest"; else echo $BRANCH; fi`
#  - echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, REPO=$REPO, PR=$PR, BRANCH=$BRANCH, TAG=$TAG"
#  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
#  - docker build -f cmd/standalone/Dockerfile -t $REPO:$COMMIT .
#  - docker tag $REPO:$COMMIT $REPO:$TAG
#  - docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER
#  - docker push $REPO
